define(["require","THREE"],function(e){"use strict";var t=e("THREE"),n=function(e){t.MeshBasicMaterial.call(this),this.depthTest=!1,this.depthWrite=!1,this.side=t.FrontSide,this.transparent=!0,this.setValues(e),this.oldColor=this.color.clone(),this.oldOpacity=this.opacity,this.highlight=function(e){e?(this.color.setRGB(1,1,0),this.opacity=1):(this.color.copy(this.oldColor),this.opacity=this.oldOpacity)}};n.prototype=Object.create(t.MeshBasicMaterial.prototype),n.prototype.constructor=n;var r=function(e){t.LineBasicMaterial.call(this),this.depthTest=!1,this.depthWrite=!1,this.transparent=!0,this.linewidth=1,this.setValues(e),this.oldColor=this.color.clone(),this.oldOpacity=this.opacity,this.highlight=function(e){e?(this.color.setRGB(1,1,0),this.opacity=1):(this.color.copy(this.oldColor),this.opacity=this.oldOpacity)}};r.prototype=Object.create(t.LineBasicMaterial.prototype),r.prototype.constructor=r;var i=new n({visible:!1,transparent:!1});t.TransformGizmo=function(){var e=this;this.init=function(){t.Object3D.call(this),this.handles=new t.Object3D,this.pickers=new t.Object3D,this.planes=new t.Object3D,this.add(this.handles),this.add(this.pickers),this.add(this.planes);var e=new t.PlaneBufferGeometry(50,50,2,2),n=new t.MeshBasicMaterial({visible:!1,side:t.DoubleSide}),r={XY:new t.Mesh(e,n),YZ:new t.Mesh(e,n),XZ:new t.Mesh(e,n),XYZE:new t.Mesh(e,n)};this.activePlane=r.XYZE,r.YZ.rotation.set(0,Math.PI/2,0),r.XZ.rotation.set(-Math.PI/2,0,0);for(var i in r)r[i].name=i,this.planes.add(r[i]),this.planes[i]=r[i];var s=function(e,t){for(var n in e)for(i=e[n].length;i--;){var r=e[n][i][0],s=e[n][i][1],o=e[n][i][2];r.name=n,s&&r.position.set(s[0],s[1],s[2]),o&&r.rotation.set(o[0],o[1],o[2]),t.add(r)}};s(this.handleGizmos,this.handles),s(this.pickerGizmos,this.pickers),this.traverse(function(e){if(e instanceof t.Mesh){e.updateMatrix();var n=e.geometry.clone();n.applyMatrix(e.matrix),e.geometry=n,e.position.set(0,0,0),e.rotation.set(0,0,0),e.scale.set(1,1,1)}})},this.highlight=function(e){this.traverse(function(t){t.material&&t.material.highlight&&(t.name===e?t.material.highlight(!0):t.material.highlight(!1))})}},t.TransformGizmo.prototype=Object.create(t.Object3D.prototype),t.TransformGizmo.prototype.constructor=t.TransformGizmo,t.TransformGizmo.prototype.update=function(e,n){var r=new t.Vector3(0,0,0),i=new t.Vector3(0,1,0),s=new t.Matrix4;this.traverse(function(t){t.name.search("E")!==-1?t.quaternion.setFromRotationMatrix(s.lookAt(n,r,i)):(t.name.search("X")!==-1||t.name.search("Y")!==-1||t.name.search("Z")!==-1)&&t.quaternion.setFromEuler(e)})},t.TransformGizmoTranslate=function(){t.TransformGizmo.call(this);var e=new t.Geometry,s=new t.Mesh(new t.CylinderGeometry(0,.05,.2,12,1,!1));s.position.y=.5,s.updateMatrix(),e.merge(s.geometry,s.matrix);var o=new t.BufferGeometry;o.addAttribute("position",new t.Float32Attribute([0,0,0,1,0,0],3));var u=new t.BufferGeometry;u.addAttribute("position",new t.Float32Attribute([0,0,0,0,1,0],3));var a=new t.BufferGeometry;a.addAttribute("position",new t.Float32Attribute([0,0,0,0,0,1],3)),this.handleGizmos={X:[[new t.Mesh(e,new n({color:16711680})),[.5,0,0],[0,0,-Math.PI/2]],[new t.Line(o,new r({color:16711680}))]],Y:[[new t.Mesh(e,new n({color:65280})),[0,.5,0]],[new t.Line(u,new r({color:65280}))]],Z:[[new t.Mesh(e,new n({color:255})),[0,0,.5],[Math.PI/2,0,0]],[new t.Line(a,new r({color:255}))]],XYZ:[[new t.Mesh(new t.OctahedronGeometry(.1,0),new n({color:16777215,opacity:.25})),[0,0,0],[0,0,0]]],XY:[[new t.Mesh(new t.PlaneBufferGeometry(.29,.29),new n({color:16776960,opacity:.25})),[.15,.15,0]]],YZ:[[new t.Mesh(new t.PlaneBufferGeometry(.29,.29),new n({color:65535,opacity:.25})),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new t.Mesh(new t.PlaneBufferGeometry(.29,.29),new n({color:16711935,opacity:.25})),[.15,0,.15],[-Math.PI/2,0,0]]]},this.pickerGizmos={X:[[new t.Mesh(new t.CylinderGeometry(.2,0,1,4,1,!1),i),[.6,0,0],[0,0,-Math.PI/2]]],Y:[[new t.Mesh(new t.CylinderGeometry(.2,0,1,4,1,!1),i),[0,.6,0]]],Z:[[new t.Mesh(new t.CylinderGeometry(.2,0,1,4,1,!1),i),[0,0,.6],[Math.PI/2,0,0]]],XYZ:[[new t.Mesh(new t.OctahedronGeometry(.2,0),i)]],XY:[[new t.Mesh(new t.PlaneBufferGeometry(.4,.4),i),[.2,.2,0]]],YZ:[[new t.Mesh(new t.PlaneBufferGeometry(.4,.4),i),[0,.2,.2],[0,Math.PI/2,0]]],XZ:[[new t.Mesh(new t.PlaneBufferGeometry(.4,.4),i),[.2,0,.2],[-Math.PI/2,0,0]]]},this.setActivePlane=function(e,n){var r=new t.Matrix4;n.applyMatrix4(r.getInverse(r.extractRotation(this.planes.XY.matrixWorld))),e==="X"&&(this.activePlane=this.planes.XY,Math.abs(n.y)>Math.abs(n.z)&&(this.activePlane=this.planes.XZ)),e==="Y"&&(this.activePlane=this.planes.XY,Math.abs(n.x)>Math.abs(n.z)&&(this.activePlane=this.planes.YZ)),e==="Z"&&(this.activePlane=this.planes.XZ,Math.abs(n.x)>Math.abs(n.y)&&(this.activePlane=this.planes.YZ)),e==="XYZ"&&(this.activePlane=this.planes.XYZE),e==="XY"&&(this.activePlane=this.planes.XY),e==="YZ"&&(this.activePlane=this.planes.YZ),e==="XZ"&&(this.activePlane=this.planes.XZ)},this.init()},t.TransformGizmoTranslate.prototype=Object.create(t.TransformGizmo.prototype),t.TransformGizmoTranslate.prototype.constructor=t.TransformGizmoTranslate,t.TransformGizmoRotate=function(){t.TransformGizmo.call(this);var e=function(e,n,r){var i=new t.BufferGeometry,s=[];r=r?r:1;for(var o=0;o<=64*r;++o)n==="x"&&s.push(0,Math.cos(o/32*Math.PI)*e,Math.sin(o/32*Math.PI)*e),n==="y"&&s.push(Math.cos(o/32*Math.PI)*e,0,Math.sin(o/32*Math.PI)*e),n==="z"&&s.push(Math.sin(o/32*Math.PI)*e,Math.cos(o/32*Math.PI)*e,0);return i.addAttribute("position",new t.Float32Attribute(s,3)),i};this.handleGizmos={X:[[new t.Line(new e(1,"x",.5),new r({color:16711680}))]],Y:[[new t.Line(new e(1,"y",.5),new r({color:65280}))]],Z:[[new t.Line(new e(1,"z",.5),new r({color:255}))]],XYZE:[[new t.Line(new e(1,"z",1),new r({color:7895160}))]]},this.pickerGizmos={X:[[new t.Mesh(new t.TorusGeometry(1,.12,4,12,Math.PI),i),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new t.Mesh(new t.TorusGeometry(1,.12,4,12,Math.PI),i),[0,0,0],[Math.PI/2,0,0]]],Z:[[new t.Mesh(new t.TorusGeometry(1,.12,4,12,Math.PI),i),[0,0,0],[0,0,-Math.PI/2]]],XYZE:[[new t.Mesh(new t.Geometry)]]},this.setActivePlane=function(e){e==="E"&&(this.activePlane=this.planes.XYZE),e==="X"&&(this.activePlane=this.planes.YZ),e==="Y"&&(this.activePlane=this.planes.XZ),e==="Z"&&(this.activePlane=this.planes.XY)},this.update=function(e,n){t.TransformGizmo.prototype.update.apply(this,arguments);var r={handles:this.handles,pickers:this.pickers},i=new t.Matrix4,s=new t.Euler(0,0,1),o=new t.Quaternion,u=new t.Vector3(1,0,0),a=new t.Vector3(0,1,0),f=new t.Vector3(0,0,1),l=new t.Quaternion,c=new t.Quaternion,h=new t.Quaternion,p=n.clone();s.copy(this.planes.XY.rotation),o.setFromEuler(s),i.makeRotationFromQuaternion(o).getInverse(i),p.applyMatrix4(i),this.traverse(function(e){o.setFromEuler(s),e.name==="X"&&(l.setFromAxisAngle(u,Math.atan2(-p.y,p.z)),o.multiplyQuaternions(o,l),e.quaternion.copy(o)),e.name==="Y"&&(c.setFromAxisAngle(a,Math.atan2(p.x,p.z)),o.multiplyQuaternions(o,c),e.quaternion.copy(o)),e.name==="Z"&&(h.setFromAxisAngle(f,Math.atan2(p.y,p.x)),o.multiplyQuaternions(o,h),e.quaternion.copy(o))})},this.init()},t.TransformGizmoRotate.prototype=Object.create(t.TransformGizmo.prototype),t.TransformGizmoRotate.prototype.constructor=t.TransformGizmoRotate,t.TransformGizmoScale=function(){t.TransformGizmo.call(this);var e=new t.Geometry,s=new t.Mesh(new t.BoxGeometry(.125,.125,.125));s.position.y=.5,s.updateMatrix(),e.merge(s.geometry,s.matrix);var o=new t.BufferGeometry;o.addAttribute("position",new t.Float32Attribute([0,0,0,1,0,0],3));var u=new t.BufferGeometry;u.addAttribute("position",new t.Float32Attribute([0,0,0,0,1,0],3));var a=new t.BufferGeometry;a.addAttribute("position",new t.Float32Attribute([0,0,0,0,0,1],3)),this.handleGizmos={X:[[new t.Mesh(e,new n({color:16711680})),[.5,0,0],[0,0,-Math.PI/2]],[new t.Line(o,new r({color:16711680}))]],Y:[[new t.Mesh(e,new n({color:65280})),[0,.5,0]],[new t.Line(u,new r({color:65280}))]],Z:[[new t.Mesh(e,new n({color:255})),[0,0,.5],[Math.PI/2,0,0]],[new t.Line(a,new r({color:255}))]],XYZ:[[new t.Mesh(new t.BoxGeometry(.125,.125,.125),new n({color:16777215,opacity:.25}))]]},this.pickerGizmos={X:[[new t.Mesh(new t.CylinderGeometry(.2,0,1,4,1,!1),i),[.6,0,0],[0,0,-Math.PI/2]]],Y:[[new t.Mesh(new t.CylinderGeometry(.2,0,1,4,1,!1),i),[0,.6,0]]],Z:[[new t.Mesh(new t.CylinderGeometry(.2,0,1,4,1,!1),i),[0,0,.6],[Math.PI/2,0,0]]],XYZ:[[new t.Mesh(new t.BoxGeometry(.4,.4,.4),i)]]},this.setActivePlane=function(e,n){var r=new t.Matrix4;n.applyMatrix4(r.getInverse(r.extractRotation(this.planes.XY.matrixWorld))),e==="X"&&(this.activePlane=this.planes.XY,Math.abs(n.y)>Math.abs(n.z)&&(this.activePlane=this.planes.XZ)),e==="Y"&&(this.activePlane=this.planes.XY,Math.abs(n.x)>Math.abs(n.z)&&(this.activePlane=this.planes.YZ)),e==="Z"&&(this.activePlane=this.planes.XZ,Math.abs(n.x)>Math.abs(n.y)&&(this.activePlane=this.planes.YZ)),e==="XYZ"&&(this.activePlane=this.planes.XYZE)},this.init()},t.TransformGizmoScale.prototype=Object.create(t.TransformGizmo.prototype),t.TransformGizmoScale.prototype.constructor=t.TransformGizmoScale,t.TransformControls=function(e,n){function W(t,r){var i=n.getBoundingClientRect(),s=(t.clientX-i.left)/i.width,o=(t.clientY-i.top)/i.height;v.set(s*2-1,-(o*2)+1),d.setFromCamera(v,e);var u=d.intersectObjects(r,!0);return u[0]?u[0]:!1}t.Object3D.call(this),n=n!==undefined?n:document,this.object=undefined,this.visible=!1,this.snap=null,this.space="world",this.size=1,this.axis=null;var r=this,i="translate",s=!1,o="XY",u={translate:new t.TransformGizmoTranslate,rotate:new t.TransformGizmoRotate,scale:new t.TransformGizmoScale};for(var a in u){var f=u[a];f.visible=a===i,this.add(f)}var l={type:"change"},c={type:"mouseDown"},h={type:"mouseUp",mode:i},p={type:"objectChange"},d=new t.Raycaster,v=new t.Vector2,m=new t.Vector3,g=new t.Vector3,y=new t.Vector3,b=new t.Vector3,w=1,E=new t.Matrix4,S=new t.Vector3,x=new t.Matrix4,T=new t.Vector3,N=new t.Quaternion,C=new t.Vector3(1,0,0),k=new t.Vector3(0,1,0),L=new t.Vector3(0,0,1),A=new t.Quaternion,O=new t.Quaternion,M=new t.Quaternion,_=new t.Quaternion,D=new t.Quaternion,P=new t.Vector3,H=new t.Vector3,B=new t.Matrix4,j=new t.Matrix4,F=new t.Vector3,I=new t.Vector3,q=new t.Euler,R=new t.Matrix4,U=new t.Vector3,z=new t.Euler;this.attach=function(e){this.object=e,this.visible=!0,this.update()},this.detach=function(){this.object=undefined,this.visible=!1,this.axis=null},this.setMode=function(e){i=e?e:i,i==="scale"&&(r.space="local");for(var t in u)u[t].visible=t===i;this.update(),r.dispatchEvent(l)},this.setSnap=function(e){r.snap=e},this.setSize=function(e){r.size=e,this.update(),r.dispatchEvent(l)},this.setSpace=function(e){r.space=e,this.update(),r.dispatchEvent(l)},this.update=function(){if(r.object===undefined)return;r.object.updateMatrixWorld(),I.setFromMatrixPosition(r.object.matrixWorld),q.setFromRotationMatrix(x.extractRotation(r.object.matrixWorld)),e.updateMatrixWorld(),U.setFromMatrixPosition(e.matrixWorld),z.setFromRotationMatrix(x.extractRotation(e.matrixWorld)),w=I.distanceTo(U)/6*r.size,this.position.copy(I),this.scale.set(w,w,w),S.copy(U).sub(I).normalize(),r.space==="local"?u[i].update(q,S):r.space==="world"&&u[i].update(new t.Euler,S),u[i].highlight(r.axis)},this.onPointerHover=function(e){if(r.object===undefined||s===!0||e.button!==undefined&&e.button!==0)return;var t=e.changedTouches?e.changedTouches[0]:e,n=W(t,u[i].pickers.children),o=null;n&&(o=n.object.name,e.preventDefault()),r.axis!==o&&(r.axis=o,r.update(),r.dispatchEvent(l))},this.onHorizontalModePointerDown=function(e,t){if(null===t)return!1;if(r.object===undefined||s===!0||e.button!==undefined&&e.button!==0)return!1;var n=e.changedTouches?e.changedTouches[0]:e;if(n.button===0||n.button===undefined)e.preventDefault(),e.stopPropagation(),r.dispatchEvent(c),r.axis="XZ",r.update(),S.copy(U).sub(I).normalize(),u[i].setActivePlane(r.axis,S),P.copy(r.object.position),H.copy(r.object.scale),B.extractRotation(r.object.matrix),R.extractRotation(r.object.matrixWorld),j.extractRotation(r.object.parent.matrixWorld),F.setFromMatrixScale(x.getInverse(r.object.parent.matrixWorld)),g.copy(t);return s=!0,!0},this.onPointerDown=function(e){var t=!1;if(r.object===undefined||s===!0||e.button!==undefined&&e.button!==0)return t;var n=e.changedTouches?e.changedTouches[0]:e;if(n.button===0||n.button===undefined){t=W(n,u[i].pickers.children);if(t){e.preventDefault(),e.stopPropagation(),r.dispatchEvent(c),r.axis=t.object.name,r.update(),S.copy(U).sub(I).normalize(),u[i].setActivePlane(r.axis,S);var o=W(n,[u[i].activePlane]);o&&(P.copy(r.object.position),H.copy(r.object.scale),B.extractRotation(r.object.matrix),R.extractRotation(r.object.matrixWorld),j.extractRotation(r.object.parent.matrixWorld),F.setFromMatrixScale(x.getInverse(r.object.parent.matrixWorld)),g.copy(o.point))}}return s=!0,t},this.onPointerMove=function(e){if(r.object===undefined||r.axis===null||s===!1||e.button!==undefined&&e.button!==0)return;var t=e.changedTouches?e.changedTouches[0]:e,n=W(t,[u[i].activePlane]);if(n===!1)return;e.preventDefault(),e.stopPropagation(),m.copy(n.point);if(i==="translate"){m.sub(g),m.multiply(F),r.space==="local"&&(m.applyMatrix4(x.getInverse(R)),r.axis.search("X")===-1&&(m.x=0),r.axis.search("Y")===-1&&(m.y=0),r.axis.search("Z")===-1&&(m.z=0),m.applyMatrix4(B),r.object.position.copy(P),r.object.position.add(m));if(r.space==="world"||r.axis.search("XYZ")!==-1)r.axis.search("X")===-1&&(m.x=0),r.axis.search("Y")===-1&&(m.y=0),r.axis.search("Z")===-1&&(m.z=0),m.applyMatrix4(x.getInverse(j)),r.object.position.copy(P),r.object.position.add(m);r.snap!==null&&(r.axis.search("X")!==-1&&(r.object.position.x=Math.round(r.object.position.x/r.snap)*r.snap),r.axis.search("Y")!==-1&&(r.object.position.y=Math.round(r.object.position.y/r.snap)*r.snap),r.axis.search("Z")!==-1&&(r.object.position.z=Math.round(r.object.position.z/r.snap)*r.snap))}else i==="scale"?(m.sub(g),m.multiply(F),r.space==="local"&&(r.axis==="XYZ"?(w=1+m.y/50,w=0>=w?.01:w,r.object.scale.x=H.x*w,r.object.scale.y=H.y*w,r.object.scale.z=H.z*w):(m.applyMatrix4(x.getInverse(R)),r.axis==="X"&&(r.object.scale.x=H.x*(0>=1+m.x/50?.01:1+m.x/50)),r.axis==="Y"&&(r.object.scale.y=H.y*(0>=1+m.y/50?.01:1+m.y/50)),r.axis==="Z"&&(r.object.scale.z=H.z*(0>=1+m.z/50?.01:1+m.z/50))))):i==="rotate"&&(m.sub(I),m.multiply(F),T.copy(g).sub(I),T.multiply(F),r.space==="local"?(m.applyMatrix4(x.getInverse(R)),T.applyMatrix4(x.getInverse(R)),y.set(Math.atan2(m.z,m.y),Math.atan2(m.x,m.z),Math.atan2(m.y,m.x)),b.set(Math.atan2(T.z,T.y),Math.atan2(T.x,T.z),Math.atan2(T.y,T.x)),A.setFromRotationMatrix(B),O.setFromAxisAngle(C,y.x-b.x),M.setFromAxisAngle(k,y.y-b.y),_.setFromAxisAngle(L,y.z-b.z),r.axis==="X"&&A.multiplyQuaternions(A,O),r.axis==="Y"&&A.multiplyQuaternions(A,M),r.axis==="Z"&&A.multiplyQuaternions(A,_),r.object.quaternion.copy(A)):r.space==="world"&&(y.set(Math.atan2(m.z,m.y),Math.atan2(m.x,m.z),Math.atan2(m.y,m.x)),b.set(Math.atan2(T.z,T.y),Math.atan2(T.x,T.z),Math.atan2(T.y,T.x)),N.setFromRotationMatrix(x.getInverse(j)),O.setFromAxisAngle(C,y.x-b.x),M.setFromAxisAngle(k,y.y-b.y),_.setFromAxisAngle(L,y.z-b.z),A.setFromRotationMatrix(R),r.axis==="X"&&N.multiplyQuaternions(N,O),r.axis==="Y"&&N.multiplyQuaternions(N,M),r.axis==="Z"&&N.multiplyQuaternions(N,_),N.multiplyQuaternions(N,A),r.object.quaternion.copy(N)));r.update(),r.dispatchEvent(l),r.dispatchEvent(p)},this.onPointerUp=function(e){if(e.button!==undefined&&e.button!==0)return;s&&r.axis!==null&&(h.mode=i,r.dispatchEvent(h)),s=!1,this.onPointerHover(e)}},t.TransformControls.prototype=Object.create(t.Object3D.prototype),t.TransformControls.prototype.constructor=t.TransformControls});